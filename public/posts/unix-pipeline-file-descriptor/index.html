<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>UNIX pipeline &amp; file descriptor :: Resyon&#39;s World</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="完成6.s081 lab1 后对pipeline, file descriptor 有了一定了解，做个笔记
 pipeline (pipe)  A pipe is a small kernel buffer exposed to processes as a pair of file descriptors, one for reading and one for writing. Writing data to one end of the pipe makes that data available for reading from the other end of the pipe. Pipes provide a way for processes to communicate.
 使用: int pd[2]; // make pipeline, return pd[0] for read, pd[1] for write if(pipe(pd) &amp;lt; 0){ // handle fail 	fprintf(stderr, &amp;#34;fail to make pipeline\n&amp;#34;); exit(1); } int pid = fork(); if(pid &amp;lt; 0){ // handle fail }else if(pid == 0){ // child 	char cnt = &amp;#34;this is test content from child process&amp;#34;; write(pd[1], cnt, strlen(cnt)); exit(0); }else{ // parent 	char buf[128]; // assume that size of content to read would not exceed buf 	read(pd[0], buf, sizeof(buf)); printf(&amp;#34;get buf from child, buf=&amp;lt;%s&amp;gt;\n&amp;#34;, buf); } file descriptor (fd) fd是对广义上的UNIX file进行引用的一层抽象，这层抽象使得在操作regular file, device, pipeline 等文件时，表面上一致，操作起来简单，(都可使用read(int fd,." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://resyon.github.io/posts/unix-pipeline-file-descriptor/" />




<link rel="stylesheet" href="https://resyon.github.io/assets/style.css">

  <link rel="stylesheet" href="https://resyon.github.io/assets/green.css">






<link rel="apple-touch-icon" href="https://resyon.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://resyon.github.io/img/favicon/green.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="UNIX pipeline &amp; file descriptor">
<meta property="og:description" content="完成6.s081 lab1 后对pipeline, file descriptor 有了一定了解，做个笔记
 pipeline (pipe)  A pipe is a small kernel buffer exposed to processes as a pair of file descriptors, one for reading and one for writing. Writing data to one end of the pipe makes that data available for reading from the other end of the pipe. Pipes provide a way for processes to communicate.
 使用: int pd[2]; // make pipeline, return pd[0] for read, pd[1] for write if(pipe(pd) &amp;lt; 0){ // handle fail 	fprintf(stderr, &amp;#34;fail to make pipeline\n&amp;#34;); exit(1); } int pid = fork(); if(pid &amp;lt; 0){ // handle fail }else if(pid == 0){ // child 	char cnt = &amp;#34;this is test content from child process&amp;#34;; write(pd[1], cnt, strlen(cnt)); exit(0); }else{ // parent 	char buf[128]; // assume that size of content to read would not exceed buf 	read(pd[0], buf, sizeof(buf)); printf(&amp;#34;get buf from child, buf=&amp;lt;%s&amp;gt;\n&amp;#34;, buf); } file descriptor (fd) fd是对广义上的UNIX file进行引用的一层抽象，这层抽象使得在操作regular file, device, pipeline 等文件时，表面上一致，操作起来简单，(都可使用read(int fd,." />
<meta property="og:url" content="https://resyon.github.io/posts/unix-pipeline-file-descriptor/" />
<meta property="og:site_name" content="Resyon&#39;s World" />

  <meta property="og:image" content="https://resyon.github.io/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-09-11 10:49:41 &#43;0800 CST" />












</head>
<body class="green">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Resyon&#39;s World
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/posts/about">About</a></li>
        
      
        
          <li><a href="https://github.com/resyon">Github</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/posts/about">About</a></li>
      
    
      
        <li><a href="https://github.com/resyon">Github</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://resyon.github.io/posts/unix-pipeline-file-descriptor/">UNIX pipeline &amp; file descriptor</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-09-11
        
      </span>
    
    
      <span class="post-author">:: resyon</span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://resyon.github.io/tags/linux/">linux</a>&nbsp;
    
  </span>
  
  


  

  <div class="post-content"><div>
        <blockquote>
<p>完成<code>6.s081</code> lab1 后对<code>pipeline</code>, <code>file descriptor</code> 有了一定了解，做个笔记</p>
</blockquote>
<h2 id="pipeline-pipe"><code>pipeline</code> (<code>pipe</code>)<a href="#pipeline-pipe" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<blockquote>
<p>A <code>pipe</code> is a small kernel buffer exposed to processes as a pair of file descriptors, one for reading and one for writing. Writing data to one end of the pipe makes that data available for reading from the other end of the pipe. Pipes provide a way for processes to communicate.</p>
</blockquote>
<h3 id="使用">使用:<a href="#使用" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> pd[<span style="color:#ae81ff">2</span>];
<span style="color:#75715e">// make pipeline, return pd[0] for read, pd[1] for write
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(pipe(pd) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
	<span style="color:#75715e">// handle fail
</span><span style="color:#75715e"></span>	fprintf(stderr, <span style="color:#e6db74">&#34;fail to make pipeline</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
	exit(<span style="color:#ae81ff">1</span>);
}

<span style="color:#66d9ef">int</span> pid <span style="color:#f92672">=</span> fork();
<span style="color:#66d9ef">if</span>(pid <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
	<span style="color:#75715e">// handle fail
</span><span style="color:#75715e"></span>}<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
	<span style="color:#75715e">// child
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">char</span> cnt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;this is test content from child process&#34;</span>;
	write(pd[<span style="color:#ae81ff">1</span>], cnt, strlen(cnt));
	exit(<span style="color:#ae81ff">0</span>);
}<span style="color:#66d9ef">else</span>{
	<span style="color:#75715e">// parent
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">128</span>];
	<span style="color:#75715e">// assume that size of content to read would not exceed buf
</span><span style="color:#75715e"></span>	read(pd[<span style="color:#ae81ff">0</span>], buf, <span style="color:#66d9ef">sizeof</span>(buf));
	printf(<span style="color:#e6db74">&#34;get buf from child, buf=&lt;%s&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
}
</code></pre></div><h2 id="file-descriptor-fd"><code>file descriptor</code> (<code>fd</code>)<a href="#file-descriptor-fd" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>fd</code>是对广义上的<code>UNIX file</code>进行引用的一层抽象，这层抽象使得在操作<code>regular file</code>, <code>device</code>, <code>pipeline</code> 等文件时，表面上一致，操作起来简单，(都可使用<code>read(int fd,..)</code>; <code>write(int fd,...)</code>等透过<code>fd</code>的<code>API</code>), 但实现上，不同类型的文件大不相同.</p>
<h3 id="几个重要的fd特性">几个重要的<code>fd</code>特性<a href="#几个重要的fd特性" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<ul>
<li>总是自动打开3个<code>fd</code>, 0=<code>stdin</code> , 1=<code>stdout</code>, 2=<code>stderr</code></li>
<li>总是选取最小的<code>fd</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">close(<span style="color:#ae81ff">1</span>);
<span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/tmp/test.c&#34;</span>, O_RDONLY);
fprintf(stderr, <span style="color:#e6db74">&#34;fd=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, fd); <span style="color:#75715e">// fd=1
</span></code></pre></div><ul>
<li><code>file descriptor table</code>由进程维护，即进程间<code>fd</code>互不影响</li>
</ul>
<blockquote>
<p>以下代码来自<code>lab 1</code>实验<code>primes</code>, 实现了下图所示的<code>埃氏筛法</code>
<img src="/upload/2021/09/image-a50ab1eafdde4f5d8e9516ed77376b38.png" alt="image.png">
为摆脱<code>xv6</code>对<code>fd</code>数目的限制，每个子进程都对管道传入的<code>fd</code>进行了多次重定向, 但在子进程改变<code>fd</code>并不影响父进程，程序能正常执行</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// redirect pd[k] to k, both pd[k] and k are fd
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">redirect</span>(<span style="color:#66d9ef">int</span> k, <span style="color:#66d9ef">int</span> pd[]){
    close(k);
    dup(pd[k]);
    close(pd[<span style="color:#ae81ff">0</span>]);
    close(pd[<span style="color:#ae81ff">1</span>]);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>(){
    <span style="color:#66d9ef">int</span> p, v, pid;
    <span style="color:#66d9ef">int</span> pd[<span style="color:#ae81ff">2</span>];
    <span style="color:#66d9ef">if</span>(read(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>p, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>))){
        printf(<span style="color:#e6db74">&#34;prime %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, p);
        pipe(pd);
	pid <span style="color:#f92672">=</span> fork();
	<span style="color:#66d9ef">if</span>(pid <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
	    fprintf(stderr, <span style="color:#e6db74">&#34;fail to fork, current pid=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, getpid());
	    <span style="color:#66d9ef">return</span>;
	}<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(pid <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){
            redirect(<span style="color:#ae81ff">0</span>, pd);
            loop();
        }<span style="color:#66d9ef">else</span>{
            redirect(<span style="color:#ae81ff">1</span>, pd);
            <span style="color:#66d9ef">while</span>(read(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>v, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>))){
                <span style="color:#66d9ef">if</span>(v <span style="color:#f92672">%</span> p <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
                    write(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>v, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
                }
            }
        }
    }
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
    <span style="color:#66d9ef">int</span> p[<span style="color:#ae81ff">2</span>];
    pipe(p);
    <span style="color:#66d9ef">if</span>(fork()<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>){
        redirect(<span style="color:#ae81ff">0</span>, p);
        loop();
    }<span style="color:#66d9ef">else</span>{
        redirect(<span style="color:#ae81ff">1</span>, p);
        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">35</span>;<span style="color:#f92672">++</span>i){
            write(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>i, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
        }
    }
    exit(<span style="color:#ae81ff">0</span>);
}
</code></pre></div><ul>
<li>经由<code>fork</code>和<code>dup</code>得到，的对同一文件的<code>fd</code>, 它们共享偏移</li>
</ul>
<blockquote>
<p>fork</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span>(fork() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
	fprintf(stdout, <span style="color:#e6db74">&#34;hello &#34;</span>);
	exit(<span style="color:#ae81ff">0</span>);
}<span style="color:#66d9ef">else</span>{
	wait((<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// wait child exit
</span><span style="color:#75715e"></span>	fprintf(stdout, <span style="color:#e6db74">&#34;world</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
	exit(<span style="color:#ae81ff">0</span>);
}

<span style="color:#75715e">// always get
</span><span style="color:#75715e">// &#34;hello world\n&#34;
</span></code></pre></div>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://resyon.github.io/posts/golang-nil-interface/">
                <span class="button__icon">←</span>
                <span class="button__text">golang nil interface</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://resyon.github.io/posts/sudoer-visudo/">
                <span class="button__text">Editor for /etc/sudoer</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>© Resyon 2022</span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://resyon.github.io/assets/main.js"></script>
<script src="https://resyon.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>

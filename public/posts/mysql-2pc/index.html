<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>mysql 事务两阶段提交 :: Resyon&#39;s World</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Mysql 事务两阶段提交 overview  准确的说是使用innodb引擎的mysql事务的两阶段提交 redo-log是innodb引擎在存储引擎层面实现的
 例表
create table t( id int primary key, c int ); 如下查询
update `t` set c=c&#43;1 where `id`=2; 有以下过程
两阶段提交的必要性 主要是保证redo-log 和 bin-log的一致性。这种必要性体现在异常恢复上。 由常识我们知道 redo-log用于保证事务的原子性和持久性，记录的是物理日志，由存储引擎实现 bin-log用于归档， 记录的逻辑日志，由mysql server 层实现
若不保证二者同步更新（不使用两阶段提交，即在二者之一完成之后立即提交事务），将出现以下两种情况
  redo-log -&amp;gt; commit -&amp;gt; bin-log 若在commit和bin-log间异常重启，系统能根据redo-log恢复事务，bin-log于是实际上少了一条记录，这就影响了后续对bin-log的使用，如构建从库，恢复到某一检查点
  bin-log -&amp;gt; commit -&amp;gt; redo-log 若在commit和redo-log间异常重启，系统无法恢复事务，而bin-log多了一条记录，而数据库里实际没有，以后用bin-log也会出现与原库不一样的问题
  总结 redo-log和bin-log都可以用于表示事务的提交状态，而两阶段提交就是让这两个状态保持逻辑上的一致。
 ref 丁奇《MySQL实战45讲》
 " />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://resyon.github.io/posts/mysql-2pc/" />




<link rel="stylesheet" href="https://resyon.github.io/assets/style.css">

  <link rel="stylesheet" href="https://resyon.github.io/assets/green.css">






<link rel="apple-touch-icon" href="https://resyon.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://resyon.github.io/img/favicon/green.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="mysql 事务两阶段提交">
<meta property="og:description" content="Mysql 事务两阶段提交 overview  准确的说是使用innodb引擎的mysql事务的两阶段提交 redo-log是innodb引擎在存储引擎层面实现的
 例表
create table t( id int primary key, c int ); 如下查询
update `t` set c=c&#43;1 where `id`=2; 有以下过程
两阶段提交的必要性 主要是保证redo-log 和 bin-log的一致性。这种必要性体现在异常恢复上。 由常识我们知道 redo-log用于保证事务的原子性和持久性，记录的是物理日志，由存储引擎实现 bin-log用于归档， 记录的逻辑日志，由mysql server 层实现
若不保证二者同步更新（不使用两阶段提交，即在二者之一完成之后立即提交事务），将出现以下两种情况
  redo-log -&amp;gt; commit -&amp;gt; bin-log 若在commit和bin-log间异常重启，系统能根据redo-log恢复事务，bin-log于是实际上少了一条记录，这就影响了后续对bin-log的使用，如构建从库，恢复到某一检查点
  bin-log -&amp;gt; commit -&amp;gt; redo-log 若在commit和redo-log间异常重启，系统无法恢复事务，而bin-log多了一条记录，而数据库里实际没有，以后用bin-log也会出现与原库不一样的问题
  总结 redo-log和bin-log都可以用于表示事务的提交状态，而两阶段提交就是让这两个状态保持逻辑上的一致。
 ref 丁奇《MySQL实战45讲》
 " />
<meta property="og:url" content="https://resyon.github.io/posts/mysql-2pc/" />
<meta property="og:site_name" content="Resyon&#39;s World" />

  <meta property="og:image" content="https://resyon.github.io/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-12-16 16:03:22 &#43;0800 CST" />












</head>
<body class="green">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Resyon&#39;s World
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/posts/about">About</a></li>
        
      
        
          <li><a href="https://github.com/resyon">Github</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/posts/about">About</a></li>
      
    
      
        <li><a href="https://github.com/resyon">Github</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://resyon.github.io/posts/mysql-2pc/">mysql 事务两阶段提交</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-12-16
        
      </span>
    
    
      <span class="post-author">:: resyon</span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://resyon.github.io/tags/mysql/">mysql</a>&nbsp;
    
  </span>
  
  


  

  <div class="post-content"><div>
        <h1 id="mysql-事务两阶段提交">Mysql 事务两阶段提交<a href="#mysql-事务两阶段提交" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h2 id="overview">overview<a href="#overview" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<blockquote>
<p>准确的说是使用<code>innodb</code>引擎的<code>mysql</code>事务的两阶段提交
<code>redo-log</code>是<code>innodb</code>引擎在存储引擎层面实现的</p>
</blockquote>
<p>例表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t(
	id int <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,
	<span style="color:#66d9ef">c</span> int
);
</code></pre></div><p>如下查询</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">update</span> <span style="color:#f92672">`</span>t<span style="color:#f92672">`</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">c</span><span style="color:#f92672">=</span><span style="color:#66d9ef">c</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> 
<span style="color:#66d9ef">where</span> <span style="color:#f92672">`</span>id<span style="color:#f92672">`=</span><span style="color:#ae81ff">2</span>;
</code></pre></div><p>有以下过程</p>
<p><img src="/upload/2021/12/image-8897670d04f14a109066df3f7d0943d0.png" alt="image.png"></p>
<h2 id="两阶段提交的必要性">两阶段提交的必要性<a href="#两阶段提交的必要性" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>主要是保证<code>redo-log</code> 和 <code>bin-log</code>的一致性。这种必要性体现在异常恢复上。
由常识我们知道
<code>redo-log</code>用于保证事务的<code>原子性</code>和<code>持久性</code>，记录的是物理日志，由存储引擎实现
<code>bin-log</code>用于归档， 记录的逻辑日志，由mysql <code>server</code> 层实现</p>
<p>若不保证二者同步更新（不使用两阶段提交，即在二者之一完成之后立即提交事务），将出现以下两种情况</p>
<ol>
<li>
<p><code>redo-log</code> -&gt; <code>commit</code> -&gt; <code>bin-log</code>
若在<code>commit</code>和<code>bin-log</code>间异常重启，系统能根据<code>redo-log</code>恢复事务，<code>bin-log</code>于是实际上少了一条记录，这就影响了后续对<code>bin-log</code>的使用，如构建从库，恢复到某一检查点</p>
</li>
<li>
<p><code>bin-log</code> -&gt; <code>commit</code> -&gt; <code>redo-log</code>
若在<code>commit</code>和<code>redo-log</code>间异常重启，系统无法恢复事务，而<code>bin-log</code>多了一条记录，而数据库里实际没有，以后用<code>bin-log</code>也会出现与原库不一样的问题</p>
</li>
</ol>
<h2 id="总结">总结<a href="#总结" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>redo-log</code>和<code>bin-log</code>都可以用于表示事务的提交状态，而两阶段提交就是让这两个状态保持逻辑上的一致。</p>
<blockquote>
<p>ref 丁奇《MySQL实战45讲》</p>
</blockquote>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://resyon.github.io/posts/my-first-post/">
                <span class="button__icon">←</span>
                <span class="button__text">博客迁移</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://resyon.github.io/posts/web-security-review-web-security-review/">
                <span class="button__text">网安选修课的期末考前急救</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>© Resyon 2022</span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://resyon.github.io/assets/main.js"></script>
<script src="https://resyon.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
